// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  CLIENT
  CAREGIVER
  FAMILY
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  DECLINED
}

enum RelationshipStatus {
  ACTIVE
  INACTIVE
}

enum ShiftStatus {
  UNFILLED
  FILLED
  CANCELLED
  COMPLETED
}

enum TimeOffType {
  DAY_OFF
  SICK_LEAVE
  VACATION
}

enum RequestStatus {
  PENDING
  APPROVED
  DENIED
}

enum RecurrenceType {
  DAILY
  WEEKLY
  BIWEEKLY
  FIRST_OF_MONTH
  LAST_OF_MONTH
}

model User {
  id                String    @id @default(cuid())
  email             String    @unique
  password          String
  role              UserRole
  emailVerified     DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Profile relationships (one-to-one)
  clientProfile     ClientProfile?
  caregiverProfile  CaregiverProfile?
  familyProfile     FamilyProfile?

  // Verification tokens
  verificationTokens VerificationToken[]

  @@index([email])
}

model ClientProfile {
  id            String   @id @default(cuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  name          String
  dateOfBirth   DateTime
  address       String

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relationships with caregivers
  caregiverInvitationsSent CaregiverInvitation[] @relation("ClientInvitations")
  caregiverRelationships   CaregiverClientRelationship[] @relation("ClientRelationships")

  // Care reports about this client
  careReports   CareReport[]

  // Medications for this client
  medications   Medication[]
  medicationAdministrations MedicationAdministration[]

  // I&O (Intake & Output) records for this client
  defecationRecords   DefecationRecord[]
  urineRecords        UrineRecord[]
  fluidIntakeRecords  FluidIntakeRecord[]

  // Nutrition (Voeding) records for this client
  mealRecords               MealRecord[]
  tubeFeedingSchedules      TubeFeedingSchedule[]
  tubeFeedingAdministrations TubeFeedingAdministration[]

  // Family relationships (future feature)
  familyMembers FamilyClientRelationship[]

  // Scheduling
  shiftTypes    ShiftType[]
  shifts        Shift[]
  shiftPatterns ShiftPattern[]
  timeOffRequests TimeOffRequest[]
  schedulingSettings SchedulingSettings?

  @@index([userId])
}

model CaregiverProfile {
  id            String   @id @default(cuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  name          String
  phoneNumber   String
  address       String
  bio           String?
  color         String?  // Hex color for scheduling calendar display

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Invitations from clients
  invitationsReceived CaregiverInvitation[] @relation("CaregiverInvitations")

  // Relationships with clients
  clientRelationships CaregiverClientRelationship[] @relation("CaregiverRelationships")

  // Care reports created by this caregiver
  careReports   CareReport[]

  // Medication administrations by this caregiver
  medicationAdministrations MedicationAdministration[]

  // I&O records created by this caregiver
  defecationRecords   DefecationRecord[]
  urineRecords        UrineRecord[]
  fluidIntakeRecords  FluidIntakeRecord[]

  // Nutrition (Voeding) records created by this caregiver
  mealRecords               MealRecord[]
  tubeFeedingAdministrations TubeFeedingAdministration[]

  // Scheduling
  shifts        Shift[]
  shiftPatterns ShiftPattern[]
  timeOffRequests TimeOffRequest[]

  @@index([userId])
  @@index([name])
  @@index([address])
}

model FamilyProfile {
  id            String   @id @default(cuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  name          String
  phoneNumber   String?
  relationship  String?  // e.g., "Daughter", "Son", "Spouse"

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Client relationships
  clientRelationships FamilyClientRelationship[]

  @@index([userId])
}

model CaregiverInvitation {
  id            String           @id @default(cuid())

  clientId      String
  client        ClientProfile    @relation("ClientInvitations", fields: [clientId], references: [id], onDelete: Cascade)

  // Either caregiverId (existing user) OR invitedEmail (new user) must be set
  caregiverId   String?
  caregiver     CaregiverProfile? @relation("CaregiverInvitations", fields: [caregiverId], references: [id], onDelete: Cascade)

  invitedEmail  String?          // Email for users who don't have an account yet

  status        InvitationStatus @default(PENDING)
  invitationToken String         @unique @default(cuid())

  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  respondedAt   DateTime?

  @@index([caregiverId, status])
  @@index([invitationToken])
  @@index([invitedEmail])
}

model CaregiverClientRelationship {
  id            String             @id @default(cuid())

  caregiverId   String
  caregiver     CaregiverProfile   @relation("CaregiverRelationships", fields: [caregiverId], references: [id], onDelete: Cascade)

  clientId      String
  client        ClientProfile      @relation("ClientRelationships", fields: [clientId], references: [id], onDelete: Cascade)

  status        RelationshipStatus @default(ACTIVE)

  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  deactivatedAt DateTime?

  @@unique([caregiverId, clientId])
  @@index([caregiverId, status])
  @@index([clientId, status])
}

model CareReport {
  id            String            @id @default(cuid())

  caregiverId   String
  caregiver     CaregiverProfile  @relation(fields: [caregiverId], references: [id], onDelete: Cascade)

  clientId      String
  client        ClientProfile     @relation(fields: [clientId], references: [id], onDelete: Cascade)

  content       String            @db.Text
  reportDate    DateTime          // The date the care was provided

  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  // Images attached to this report
  images        CareReportImage[]

  // Version history for edits
  versions      CareReportVersion[]

  @@index([caregiverId])
  @@index([clientId])
  @@index([reportDate])
  @@index([clientId, reportDate])
}

model CareReportImage {
  id            String     @id @default(cuid())

  reportId      String
  report        CareReport @relation(fields: [reportId], references: [id], onDelete: Cascade)

  imageData     Bytes      // Store image as binary data
  mimeType      String     // e.g., "image/jpeg", "image/png"
  fileName      String
  fileSize      Int        // in bytes

  createdAt     DateTime   @default(now())

  @@index([reportId])
}

model CareReportVersion {
  id            String     @id @default(cuid())

  reportId      String
  report        CareReport @relation(fields: [reportId], references: [id], onDelete: Cascade)

  content       String     @db.Text  // The content at this version
  versionNumber Int                  // 1 = original, 2 = first edit, etc.

  createdAt     DateTime   @default(now())

  @@index([reportId])
  @@unique([reportId, versionNumber])
}

model FamilyClientRelationship {
  id            String        @id @default(cuid())

  familyId      String
  family        FamilyProfile @relation(fields: [familyId], references: [id], onDelete: Cascade)

  clientId      String
  client        ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)

  canViewReports Boolean      @default(true)

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@unique([familyId, clientId])
  @@index([familyId])
  @@index([clientId])
}

model VerificationToken {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token      String   @unique
  expires    DateTime
  createdAt  DateTime @default(now())

  @@unique([userId, token])
  @@index([token])
}

model SystemSettings {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String   @db.Text
  category  String   // "general", "email", "security", "privacy"
  updatedAt DateTime @updatedAt
  updatedBy String?  // User ID who last updated this setting

  @@index([category])
  @@index([key])
}

// Medication management
model Medication {
  id              String   @id @default(cuid())

  clientId        String
  client          ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)

  name            String   // Medicine name
  dosage          String   // e.g., "10mg", "2 tablets"
  unit            String   // e.g., "mg", "ml", "tablets"
  frequency       String   // e.g., "daily", "twice daily", "as needed"
  instructions    String?  @db.Text // Special instructions

  // Timing - times during the day when medication should be given
  times           String   // JSON array of times: ["08:00", "20:00"]

  isActive        Boolean  @default(true)
  startDate       DateTime @default(now())
  endDate         DateTime? // Optional end date for temporary medications
  imageUrl        String?  @db.Text // Optional image of the medication (supports base64)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdBy       String   // User ID who created this medication entry

  // Administrations of this medication
  administrations MedicationAdministration[]

  @@index([clientId])
  @@index([isActive])
  @@index([startDate])
}

model MedicationAdministration {
  id              String   @id @default(cuid())

  medicationId    String
  medication      Medication @relation(fields: [medicationId], references: [id], onDelete: Cascade)

  clientId        String
  client          ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)

  caregiverId     String
  caregiver       CaregiverProfile @relation(fields: [caregiverId], references: [id], onDelete: Cascade)

  scheduledTime   DateTime // When medication should have been given
  administeredAt  DateTime @default(now()) // When it was actually given

  dosageGiven     String   // Actual dosage given (might differ from prescribed)
  notes           String?  @db.Text // Any notes about this administration

  wasGiven        Boolean  @default(true) // false if medication was skipped/refused
  skipReason      String?  // Reason if wasGiven is false

  createdAt       DateTime @default(now())

  @@index([medicationId])
  @@index([clientId])
  @@index([caregiverId])
  @@index([scheduledTime])
  @@index([administeredAt])
}

// I&O (Intake & Output) Management
model DefecationRecord {
  id              String   @id @default(cuid())

  clientId        String
  client          ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)

  caregiverId     String
  caregiver       CaregiverProfile @relation(fields: [caregiverId], references: [id], onDelete: Cascade)

  recordDate      DateTime // The date of the defecation
  recordTime      DateTime // The time of the defecation

  amount          String?  // e.g., "none", "little", "normal", "alot"
  consistency     String?  // e.g., "normal", "diarrhea", "constipation"
  notes           String?  @db.Text

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([clientId])
  @@index([caregiverId])
  @@index([recordDate])
  @@index([clientId, recordDate])
}

model UrineRecord {
  id              String   @id @default(cuid())

  clientId        String
  client          ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)

  caregiverId     String
  caregiver       CaregiverProfile @relation(fields: [caregiverId], references: [id], onDelete: Cascade)

  recordDate      DateTime // The date of the urination
  recordTime      DateTime // The time of the urination

  volume          Int      // Volume in ml
  notes           String?  @db.Text

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([clientId])
  @@index([caregiverId])
  @@index([recordDate])
  @@index([clientId, recordDate])
}

model FluidIntakeRecord {
  id              String   @id @default(cuid())

  clientId        String
  client          ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)

  caregiverId     String
  caregiver       CaregiverProfile @relation(fields: [caregiverId], references: [id], onDelete: Cascade)

  recordDate      DateTime // The date of the fluid intake
  recordTime      DateTime // The time of the fluid intake

  volume          Int      // Volume in ml
  fluidType       String?  // e.g., "water", "coffee", "tea", "juice"
  notes           String?  @db.Text

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([clientId])
  @@index([caregiverId])
  @@index([recordDate])
  @@index([clientId, recordDate])
}

// Nutrition (Voeding) Management
model MealRecord {
  id              String   @id @default(cuid())

  clientId        String
  client          ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)

  caregiverId     String
  caregiver       CaregiverProfile @relation(fields: [caregiverId], references: [id], onDelete: Cascade)

  recordDate      DateTime // The date of the meal
  recordTime      DateTime // The time of the meal

  mealType        String   // "breakfast", "lunch", "dinner", "snack"
  description     String   @db.Text // What was eaten
  amount          String?  // e.g., "none", "little", "normal", "much"
  notes           String?  @db.Text

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([clientId])
  @@index([caregiverId])
  @@index([recordDate])
  @@index([clientId, recordDate])
}

model TubeFeedingSchedule {
  id              String   @id @default(cuid())

  clientId        String
  client          ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)

  feedingTime     String   // e.g., "08:00"
  volume          Int      // Volume in ml
  feedSpeed       Int      // Speed in ml/hour
  feedType        String?  // Type of nutrition formula

  // Recurrence settings
  recurrenceType  String   @default("daily") // "daily", "weekly", "specific_days", "one_time"
  daysOfWeek      String?  // JSON array: ["monday", "wednesday", "friday"] for weekly schedules
  startDate       DateTime @default(now()) // When schedule becomes active
  endDate         DateTime? // Optional end date for temporary schedules

  isActive        Boolean  @default(true)
  createdBy       String   // User ID who created this schedule

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Administrations of this feeding
  administrations TubeFeedingAdministration[]

  @@index([clientId])
  @@index([isActive])
  @@index([recurrenceType])
  @@index([clientId, isActive])
}

model TubeFeedingAdministration {
  id              String   @id @default(cuid())

  scheduleId      String
  schedule        TubeFeedingSchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

  clientId        String
  client          ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)

  caregiverId     String
  caregiver       CaregiverProfile @relation(fields: [caregiverId], references: [id], onDelete: Cascade)

  scheduledTime   DateTime // When feeding should have been given
  administeredAt  DateTime @default(now()) // When it was actually given

  volumeGiven     Int      // Actual volume given (might differ from scheduled)
  speedUsed       Int      // Actual speed used
  notes           String?  @db.Text // Any notes about this administration

  wasGiven        Boolean  @default(true) // false if feeding was skipped
  skipReason      String?  // Reason if wasGiven is false

  createdAt       DateTime @default(now())

  @@index([scheduleId])
  @@index([clientId])
  @@index([caregiverId])
  @@index([scheduledTime])
  @@index([administeredAt])
}

// ============================================
// SCHEDULING SYSTEM
// ============================================

// Shift types defined by client (e.g., "Early Shift", "Late Shift", "Night Shift")
model ShiftType {
  id           String   @id @default(cuid())

  clientId     String
  client       ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)

  name         String   // "Early Shift", "Late Shift", etc.
  startTime    String   // "06:00" (HH:mm format)
  endTime      String   // "14:00" (HH:mm format)
  color        String   // Hex color for UI display (e.g., "#3B82F6")

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  shifts       Shift[]
  shiftPatterns ShiftPattern[]

  @@index([clientId])
}

// Individual shift instances (actual scheduled shifts)
model Shift {
  id              String   @id @default(cuid())

  clientId        String
  client          ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)

  shiftTypeId     String
  shiftType       ShiftType @relation(fields: [shiftTypeId], references: [id], onDelete: Cascade)

  date            DateTime // Date of this shift (time part should be midnight)
  startTime       String   // Actual start time (can override shiftType default)
  endTime         String   // Actual end time (can override shiftType default)

  caregiverId     String?  // null = unfilled shift
  caregiver       CaregiverProfile? @relation(fields: [caregiverId], references: [id], onDelete: SetNull)

  status          ShiftStatus @default(UNFILLED)

  // Pattern tracking for recurring shifts
  patternId       String?  // Links shifts that are part of same recurring pattern
  isPatternOverride Boolean @default(false) // true if manually changed from pattern

  // Two types of notes
  internalNotes   String?  @db.Text // Client-only notes
  instructionNotes String? @db.Text // Visible to assigned caregiver

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdBy       String   // User ID who created this shift

  @@index([clientId, date])
  @@index([caregiverId, date])
  @@index([shiftTypeId])
  @@index([patternId])
  @@index([status])
  @@index([date])
}

// Recurring shift patterns (e.g., "John works early shift every Monday")
model ShiftPattern {
  id              String   @id @default(cuid())

  clientId        String
  client          ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)

  caregiverId     String?
  caregiver       CaregiverProfile? @relation(fields: [caregiverId], references: [id], onDelete: Cascade)

  shiftTypeId     String
  shiftType       ShiftType @relation(fields: [shiftTypeId], references: [id], onDelete: Cascade)

  recurrenceType  RecurrenceType @default(WEEKLY) // How the pattern repeats

  startDate       DateTime @default(now()) // Pattern starts applying from this date (determines day of week)
  endDate         DateTime? // Optional end date for temporary patterns

  isActive        Boolean  @default(true)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdBy       String   // User ID who created this pattern

  @@index([clientId])
  @@index([caregiverId])
  @@index([shiftTypeId])
  @@index([isActive])
  @@index([clientId, isActive])
}

// Time-off requests from caregivers
model TimeOffRequest {
  id              String   @id @default(cuid())

  caregiverId     String
  caregiver       CaregiverProfile @relation(fields: [caregiverId], references: [id], onDelete: Cascade)

  clientId        String
  client          ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)

  requestType     TimeOffType // DAY_OFF, SICK_LEAVE, VACATION
  startDate       DateTime // Start of time off (date only, time should be midnight)
  endDate         DateTime // End of time off (date only, time should be midnight)

  reason          String?  @db.Text

  status          RequestStatus @default(PENDING)
  reviewedBy      String?  // User ID who approved/denied
  reviewedAt      DateTime?
  reviewNotes     String?  @db.Text

  // For emergency sick leave
  isEmergency     Boolean  @default(false) // true for same-day sick calls

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([caregiverId])
  @@index([clientId])
  @@index([status])
  @@index([requestType])
  @@index([startDate, endDate])
}

// Client-specific scheduling settings
model SchedulingSettings {
  id              String   @id @default(cuid())

  clientId        String   @unique
  client          ClientProfile @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // How many weeks ahead to generate shifts from patterns
  weeksAhead      Int      @default(8)

  // Last time patterns were processed
  lastGenerated   DateTime?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([clientId])
}
